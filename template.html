<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <title>$titleçš„å¿«ç…§</title>
    <style>
        /* åŸºç¡€å…¨å±€æ ·å¼ */
        body {
            font-family: Consolas, Menlo, monospace;
            background: #f9f9f9;
            color: #333;
            margin: 0;
            padding: 1em;
        }
        .container {
            max-width: 1000px;
            margin: auto;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 0.5em;
        }
        .controls {
            margin-bottom: 1em;
        }
        /* æ§ä»¶æ ·å¼ */
        input.search {
            padding: 6px 8px;
            border: 1px solid #bbb;
            border-radius: 4px;
            min-width: 240px;
        }
        button {
            padding: 5px 10px;
            border: 1px solid #bbb;
            background: #eee;
            border-radius: 4px;
            cursor: pointer;
        }
        /* æ ‘å½¢ç»“æ„æ ·å¼ */
        ul {
            list-style: none;
            padding-left: 20px;
            margin: 0;
        }
        li {
            line-height: 1.5;
            position: relative;
        }
        li::before {
            content: '';
            position: absolute;
            top: 0;
            left: -10px;
            width: 1px;
            height: 100%;
            background: #ccc;
        }
        li:last-child::before {
            height: 12px;
        }
        /* æ–‡ä»¶/æ–‡ä»¶å¤¹å›¾æ ‡ */
        li.dir > .icon.folder::before {
            content: 'ğŸ“';
            margin-right: 4px;
        }
        li.file > .icon.file::before {
            content: 'ğŸ“„';
            margin-right: 4px;
        }
        /* ç›®å½•å±•å¼€/æ”¶èµ·æ§åˆ¶ */
        .dir > ul {
            display: none;
        }
        .dir.expanded > ul {
            display: block;
        }
        .dir > .label {
            cursor: pointer;
            color: #005bbb;
        }
        /* æ–‡ä»¶é“¾æ¥æ ·å¼ */
        li.file > .label a {
            color: #2e7d32;
            text-decoration: none;
        }
        li.file > .label a:hover {
            color: #1b5e20;
            text-decoration: underline;
        }
        li.file > .label a:visited {
            color: #4a148c;
        }
        /* è¾…åŠ©æ ·å¼ */
        .meta {
            color: #666;
            font-size: 0.85em;
            margin-left: 1px;
        }
        .match {
            background: #fffbdd;
        }
        .hidden {
            display: none !important;
        }
        .small {
            color: #666;
            font-size: 0.85em;
        }
        .count-info {
            color: #005bbb;
            margin: 0 0 1em 0;
            font-size: 0.9em;
        }
        /* å›åˆ°é¡¶éƒ¨æ‚¬æµ®æŒ‰é’® */
        #back-to-top {
            position: fixed;
            right: 25px;
            bottom: 25px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #005bbb;
            color: #ffffff;
            border: none;
            outline: none;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        /* æŒ‰é’®æ‚¬æµ®å˜è‰²æ•ˆæœ */
        #back-to-top:hover {
            background: #0078d7;
            transform: scale(1.05);
        }
        /* æŒ‰é’®æ˜¾ç¤ºçš„æ ·å¼ç±» */
        #back-to-top.show {
            opacity: 1;
            visibility: visible;
        }
        /* å‡ºé”™ç›®å½•æ ·å¼ */
        li.dir[data-error='true'] {
            background: #b03f3f;
        }
        li.dir[data-error='true'] .meta{
            color: #f7ff14;
        }
        li.dir[data-error='true'] .label{
            color: #f7ff14;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å¿«ç…§: $root_display</h1><!-- {root_display} > $root_display -->
        <p class="small">ç”Ÿæˆæ—¶é—´: $now</p>
        <p class="count-info">å…± $dirs_count ä¸ªæ–‡ä»¶å¤¹ | $files_count ä¸ªæ–‡ä»¶</p>
        <div class="controls">
            <input id="search" class="search" placeholder="ç‚¹æ­¤è¾“å…¥æœç´¢å†…å®¹..." />
            <button id="search-btn" style="margin-left: 8px;">æœç´¢</button>
            <button id="clear">æ¸…é™¤</button>
            <button id="toggle-all-btn" style="margin-left: 8px;">å…¨éƒ¨å±•å¼€</button>
        </div>
        <ul id="tree">$tree_html</ul>
        <p class="small">ç‚¹å‡»åç§°å±•å¼€/æ”¶èµ·</p>
        <p class="small">Tree2HTML HAFåŠä¸ªæ°´æœ <a href='https://github.com/Little-Data/Tree2HTML' target='_blank'>https://github.com/Little-Data/Tree2HTML</a></p>
    </div>
    <button id="back-to-top">â†‘</button>

    <script>
        (function() {
            // è·å–é¡µé¢æ ¸å¿ƒDOMå…ƒç´ 
            const tree = document.getElementById('tree');
            const searchInput = document.getElementById('search');
            const searchBtn = document.getElementById('search-btn');
            const clearBtn = document.getElementById('clear');
            const toggleAllBtn = document.getElementById('toggle-all-btn');
            const backToTopBtn = document.getElementById('back-to-top');
            
            // å…¨å±€çŠ¶æ€ï¼šæ˜¯å¦å…¨éƒ¨å±•å¼€
            let isAllExpanded = false;

            // æ»šåŠ¨å®šæ—¶å™¨ï¼Œç”¨äºæ§åˆ¶æŒ‰é’®éšè—å»¶è¿Ÿ
            let scrollTimer = null;

            // åœæ­¢æ»šåŠ¨åéšè—æŒ‰é’®çš„å»¶è¿Ÿæ—¶é—´(æ¯«ç§’)
            const HIDE_DELAY = 2000;

            // æ»šåŠ¨å¤šå°‘è·ç¦»åæ˜¾ç¤ºæŒ‰é’®
            let SHOW_OFFSET = 500;

            // ç›®å½•æ•°é‡æ–‡æœ¬
            function initDirMetaText() {
                const emptyDirText = "[ç©º]";
                const dirFileCountText = (dirNum, fileNum) => `[${dirNum} ä¸ªæ–‡ä»¶å¤¹ | ${fileNum} ä¸ªæ–‡ä»¶]`;
                const errorDirText = "[è¯»å–å‡ºé”™]";

                // éå†æ‰€æœ‰ç›®å½•èŠ‚ç‚¹ï¼Œæ›¿æ¢metaæ–‡æœ¬
                document.querySelectorAll('li.dir').forEach(dirLi => {
                    const dirCount = parseInt(dirLi.dataset.dirCount || 0);
                    const fileCount = parseInt(dirLi.dataset.fileCount || 0);
                    const metaSpan = dirLi.querySelector('.meta');
                    if (metaSpan) {
                        let countText;
                        if (dirLi.dataset.error === 'true') {
                            // å‡ºé”™ç›®å½•ï¼šæ›¿æ¢ä¸º[è¯»å–å‡ºé”™]ï¼Œå¹¶ä¿ç•™çº¢è‰²èƒŒæ™¯
                            countText = errorDirText;
                        } else {
                            // ç©ºç›®å½•ï¼šæ›¿æ¢ä¸º[ç©º]ï¼Œéç©ºåˆ™æ˜¾ç¤ºæ•°é‡
                            countText = dirCount + fileCount === 0 ? emptyDirText : dirFileCountText(dirCount, fileCount);
                        }
                        // æ›¿æ¢åŸæœ‰æ—¶é—´æ–‡æœ¬ä¸ºæœ€ç»ˆæç¤ºæ–‡æœ¬
                        metaSpan.textContent = countText;
                    }
                });
            }

            // è½¬å°å†™ï¼Œç”¨äºæœç´¢åŒ¹é…ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
            function normalize(str) {
                return (str || '').toLowerCase();
            }

            // é‡ç½®æœç´¢ç»“æœï¼šæ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼Œç§»é™¤é«˜äº®åŒ¹é…æ ·å¼
            function showAllItems() {
                const allLi = document.querySelectorAll('li');
                const allDirs = document.querySelectorAll('.dir');
                // æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹ + ç§»é™¤é«˜äº®
                allLi.forEach(item => {
                    item.classList.remove('hidden', 'match');
                });
                // æ¸…é™¤åï¼Œæ‰€æœ‰ç›®å½•å¼ºåˆ¶å±•å¼€
                allDirs.forEach(dir => {
                    dir.classList.add('expanded');
                    dir.classList.remove('collapsed');
                });
                // åŒæ­¥å…¨å±€çŠ¶æ€+æŒ‰é’®æ–‡å­—
                isAllExpanded = true;
                toggleAllBtn.textContent = 'å…¨éƒ¨æ”¶èµ·';
            }

            function backToTop() {
                // å¹³æ»‘æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }

            // æ˜¾ç¤ºå›åˆ°é¡¶éƒ¨æŒ‰é’®
            function showBackBtn() {
                backToTopBtn.classList.add('show');
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼Œé¿å…é‡å¤è§¦å‘éšè—
                if (scrollTimer) clearTimeout(scrollTimer);
            }

            // éšè—å›åˆ°é¡¶éƒ¨æŒ‰é’®
            function hideBackBtn() {
                scrollTimer = setTimeout(() => {
                    backToTopBtn.classList.remove('show');
                }, HIDE_DELAY);
            }

            // ç›®å½•ç‚¹å‡»å±•å¼€/æ”¶èµ·
            tree.addEventListener('click', function(e) {
                // åªç›‘å¬æ–‡ä»¶å¤¹åç§°çš„ç‚¹å‡»äº‹ä»¶
                if (e.target.classList.contains('label')) {
                    const li = e.target.closest('li');
                    // ä»…å¤„ç†æ–‡ä»¶å¤¹ç±»å‹çš„èŠ‚ç‚¹
                    if (!li || !li.classList.contains('dir')) return;
                    // åˆ‡æ¢å±•å¼€/æ”¶èµ·çš„æ ·å¼ç±»
                    li.classList.toggle('expanded');
                    li.classList.toggle('collapsed');
                }
            });

            // æ–‡ä»¶/æ–‡ä»¶å¤¹æœç´¢è¿‡æ»¤
            function filterItems(searchTerm) {
                const term = normalize(searchTerm);
                if (!term) {
                    showAllItems();
                    return;
                }
                
                document.querySelectorAll('li').forEach(item => {
                    const itemName = normalize(item.dataset.name || '');
                    if (itemName.indexOf(term) !== -1) {
                        item.classList.remove('hidden');
                        item.classList.add('match');
                        // é€’å½’æ˜¾ç¤ºæ‰€æœ‰ä¸Šçº§ç›®å½•ï¼Œç¡®ä¿åŒ¹é…é¡¹å¯è§
                        let parentNode = item.parentElement;
                        while (parentNode && parentNode.id !== 'tree') {
                            if (parentNode.tagName.toLowerCase() === 'li') {
                                parentNode.classList.remove('hidden');
                                parentNode.classList.add('expanded');
                            }
                            parentNode = parentNode.parentElement;
                        }
                    } else {
                        item.classList.add('hidden');
                        item.classList.remove('match');
                    }
                });
                // åŒæ­¥å…¨å±€çŠ¶æ€+æŒ‰é’®æ–‡å­—
                isAllExpanded = true;
                toggleAllBtn.textContent = 'å…¨éƒ¨æ”¶èµ·';
            }

            // ç‚¹å‡»æœç´¢æŒ‰é’®è§¦å‘æœç´¢
            searchBtn.addEventListener('click', () => {
                filterItems(searchInput.value);
            });

            // å›è½¦è§¦å‘æœç´¢
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    filterItems(searchInput.value);
                }
            });

            // æ¸…ç©ºæœç´¢æ¡†+é‡ç½®æ˜¾ç¤º+èšç„¦è¾“å…¥æ¡†
            clearBtn.addEventListener('click', () => {
                searchInput.value = '';
                showAllItems();
                searchInput.focus();
            });

            // å…¨éƒ¨å±•å¼€ / å…¨éƒ¨æ”¶èµ· åˆ‡æ¢
            toggleAllBtn.addEventListener('click', function() {
                const allDirNodes = document.querySelectorAll('.dir');
                
                if (!isAllExpanded) {
                    // å…¨éƒ¨å±•å¼€é€»è¾‘
                    allDirNodes.forEach(dir => {
                        dir.classList.add('expanded');
                        dir.classList.remove('collapsed');
                    });
                    toggleAllBtn.textContent = 'å…¨éƒ¨æ”¶èµ·';
                } else {
                    // å…¨éƒ¨æ”¶èµ·é€»è¾‘
                    allDirNodes.forEach(dir => {
                        dir.classList.add('collapsed');
                        dir.classList.remove('expanded');
                    });
                    toggleAllBtn.textContent = 'å…¨éƒ¨å±•å¼€';
                }
                // åˆ‡æ¢å…¨å±€çŠ¶æ€
                isAllExpanded = !isAllExpanded;
            });

            // ç›‘å¬é¡µé¢æ»šåŠ¨
            window.addEventListener('scroll', function() {
                // æ»šåŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼ï¼Œæ˜¾ç¤ºæŒ‰é’®å¦åˆ™ç›´æ¥éšè—
                if (window.pageYOffset > SHOW_OFFSET) {
                    showBackBtn();
                } else {
                    hideBackBtn();
                    if(scrollTimer) clearTimeout(scrollTimer);
                    return;
                }
                
                clearTimeout(scrollTimer);
                // åœæ­¢æ»šåŠ¨åï¼Œå»¶è¿ŸæŒ‡å®šæ—¶é—´è‡ªåŠ¨éšè—æŒ‰é’®
                scrollTimer = setTimeout(() => {
                    hideBackBtn();
                }, HIDE_DELAY);
            });

            // ç‚¹å‡»æŒ‰é’®å›åˆ°é¡¶éƒ¨
            backToTopBtn.addEventListener('click', backToTop);

            // ç›®å½•æ•°é‡æ–‡æœ¬åˆå§‹åŒ–
            initDirMetaText();

        })();
    </script>
</body>
</html>
